import e from"@logue/reverb";function t(e,t,n,i,s,r,a){try{var o=e[r](a),h=o.value}catch(e){return void n(e)}o.done?t(h):Promise.resolve(h).then(i,s)}function n(e){return function(){var n=this,i=arguments;return new Promise((function(s,r){var a=e.apply(n,i);function o(e){t(a,s,r,o,h,"next",e)}function h(e){t(a,s,r,o,h,"throw",e)}o(void 0)}))}}class i{constructor(e,t,n){this.ctx=e,this.destination=t,this.instrument=n,this.channel=n.channel,this.key=n.key,this.velocity=n.velocity,this.buffer=n.sample,this.playbackRate=n.basePlaybackRate,this.loopStart=n.loopStart,this.loopEnd=n.loopEnd,this.sampleRate=n.sampleRate,this.volume=n.volume,this.panpot=n.panpot,this.pitchBend=n.pitchBend,this.pitchBendSensitivity=n.pitchBendSensitivity,this.modEnvToPitch=n.modEnvToPitch,this.expression=n.expression,this.cutOffFrequency=n.cutOffFrequency,this.hermonicContent=n.hermonicContent,this.reverb=n.reverb,this.startTime=e.currentTime,this.computedPlaybackRate=0|this.playbackRate,this.noteOffState=!1,this.audioBuffer,this.bufferSource=e.createBufferSource(),this.panner=e.createPanner(),this.outputGainNode=e.createGain(),this.expressionGainNode=e.createGain(),this.filter=e.createBiquadFilter(),this.modulator=e.createBiquadFilter()}noteOn(){var e=this.ctx,t=this.instrument,n=this.ctx.currentTime||0,i=n+t.volDelay,s=n+t.modDelay,r=i+t.volAttack,a=i+t.modAttack,o=r+t.volHold,h=a+t.modHold,l=o+t.volDecay,u=h+t.modDecay,c=t.loopStart/this.sampleRate,d=t.loopEnd/this.sampleRate,p=t.start/this.sampleRate,m=void 0!==t.pan?t.pan:this.panpot,f=this.buffer.subarray(0,this.buffer.length+t.end),v=this.audioBuffer=e.createBuffer(1,f.length,this.sampleRate);v.getChannelData(0).set(f);var g=this.bufferSource;g.buffer=v,g.loop=0|t.sampleModes||0,g.loopStart=c,g.loopEnd=d,this.updatePitchBend(this.pitchBend);var y=this.outputGainNode;this.expressionGainNode.gain.value=this.expression/127;var k=this.panner;k.panningModel="equalpower",k.setPosition(Math.sin(m*Math.PI/2),0,Math.cos(m*Math.PI/2));var b=this.volume*(this.velocity/127)*(1-t.initialAttenuation/1e3);b<0&&(b=0);var S=y.gain;S.setValueAtTime(0,n),S.setValueAtTime(0,i),S.setTargetAtTime(b,i,t.volAttack),S.setValueAtTime(b,o),S.linearRampToValueAtTime(b*(1-t.volSustain),l);var A=this.amountToFreq(t.initialFilterFc),M=this.amountToFreq(t.initialFilterFc+t.modEnvToFilterFc),T=A+(M-A)*(1-t.modSustain),G=this.modulator;G.Q.setValueAtTime(10**(t.initialFilterQ/200),n),G.frequency.value=A,G.type="lowpass",G.frequency.setTargetAtTime(A/127,this.ctx.currentTime,.5),G.frequency.setValueAtTime(A,n),G.frequency.setValueAtTime(A,s),G.frequency.setTargetAtTime(M,s,parseFloat(t.modAttack+1)),G.frequency.setValueAtTime(M,h),G.frequency.linearRampToValueAtTime(T,u),g.connect(G),G.connect(k),k.connect(this.expressionGainNode),this.expressionGainNode.connect(y),t.mute||this.connect(),g.start(0,p)}amountToFreq(e){return 2**((e-6900)/1200)*440}noteOff(){this.noteOffState=!0}isNoteOff(){return this.noteOffState}release(){var e=this.instrument,t=this.bufferSource,n=this.outputGainNode,i=this.ctx.currentTime,s=e.releaseTime-64,r=i+e.volRelease*n.gain.value*(1+s/(s<0?64:63)),a=this.modulator,o=this.amountToFreq(e.initialFilterFc),h=this.amountToFreq(e.initialFilterFc+e.modEnvToFilterFc),l=i+e.modRelease*(o===h?1:(a.frequency.value-o)/(h-o));if(this.audioBuffer)switch(e.sampleModes){case 0:t.loop=!1,t.disconnect(),t.buffer=null;break;case 1:n.gain.cancelScheduledValues(0),n.gain.setValueAtTime(n.gain.value,i),n.gain.linearRampToValueAtTime(0,r),a.frequency.cancelScheduledValues(0),a.frequency.setValueAtTime(a.frequency.value,i),a.frequency.linearRampToValueAtTime(o,l),t.playbackRate.cancelScheduledValues(0),t.playbackRate.setValueAtTime(t.playbackRate.value,i),t.playbackRate.linearRampToValueAtTime(this.computedPlaybackRate,l),t.stop(r);break;case 2:console.error("detect unused sampleModes");break;case 3:n.gain.cancelScheduledValues(0),n.gain.setValueAtTime(n.gain.value,i),n.gain.linearRampToValueAtTime(0,r),a.frequency.cancelScheduledValues(0),a.frequency.setValueAtTime(a.frequency.value,i),a.frequency.linearRampToValueAtTime(o,l),t.playbackRate.cancelScheduledValues(0),t.playbackRate.setValueAtTime(t.playbackRate.value,i),t.playbackRate.linearRampToValueAtTime(this.computedPlaybackRate,l);default:t.loop=!1}}connect(){this.reverb.connect(this.outputGainNode).connect(this.destination)}disconnect(){this.outputGainNode.disconnect(0)}schedulePlaybackRate(){var e=this.bufferSource.playbackRate,t=this.computedPlaybackRate,n=this.startTime,i=this.instrument,s=n+i.modAttack,r=s+i.modDecay,a=t*1.0594630943592953**(this.modEnvToPitch*this.instrument.scaleTuning);e.cancelScheduledValues(0),e.setValueAtTime(t,n),e.linearRampToValueAtTime(a,s),e.linearRampToValueAtTime(t+(a-t)*(1-i.modSustain),r)}updateExpression(e){this.expressionGainNode.gain.value=(this.expression=e)/127}updatePitchBend(e){this.computedPlaybackRate=this.playbackRate*1.0594630943592953**(e/(e<0?8192:8191)*this.pitchBendSensitivity*this.instrument.scaleTuning),this.schedulePlaybackRate()}}class s{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.input=e,this.ip=t.index||0,this.length=t.length||e.length-this.ip,this.chunkList,this.offset=this.ip,this.padding=void 0===t.padding||t.padding,this.bigEndian=void 0!==t.bigEndian&&t.bigEndian}parse(){var e=this.length+this.offset;for(this.chunkList=[];this.ip<e;)this.parseChunk()}parseChunk(){var e,t=this.input,n=this.ip;this.chunkList.push(new r(String.fromCharCode(t[n++],t[n++],t[n++],t[n++]),e=this.bigEndian?(t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++])>>>0:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,n)),n+=e,this.padding&&1==(n-this.offset&1)&&n++,this.ip=n}getChunk(e){var t=this.chunkList[e];return void 0===t?null:t}getNumberOfChunks(){return this.chunkList.length}}class r{constructor(e,t,n){this.type=e,this.size=t,this.offset=n}}class a{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.input=e,this.parserOption=t.parserOption||{},this.sampleRate=t.sampleRate||22050,this.presetHeader,this.presetZone,this.presetZoneModulator,this.presetZoneGenerator,this.instrument,this.instrumentZone,this.instrumentZoneModulator,this.instrumentZoneGenerator,this.sampleHeader,this.GeneratorEnumeratorTable=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",,"chorusEffectsSend","reverbEffectsSend","pan",,,,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",,"scaleTuning","exclusiveClass","overridingRootKey","endOper"]}parse(){var e=new s(this.input,this.parserOption);if(e.parse(),1!==e.chunkList.length)throw new Error("wrong chunk length");var t=e.getChunk(0);if(null===t)throw new Error("chunk not found");this.parseRiffChunk(t),this.input=null}parseRiffChunk(e){var t=this.input,n=e.offset;if("RIFF"!==e.type)throw new Error("invalid chunk type:"+e.type);var i=String.fromCharCode(t[n++],t[n++],t[n++],t[n++]);if("sfbk"!==i)throw new Error("invalid signature:"+i);var r=new s(t,{index:n,length:e.size-4});if(r.parse(),3!==r.getNumberOfChunks())throw new Error("invalid sfbk structure");this.parseInfoList(r.getChunk(0)),this.parseSdtaList(r.getChunk(1)),this.parsePdtaList(r.getChunk(2))}parseInfoList(e){var t=this.input,n=e.offset;if("LIST"!==e.type)throw new Error("invalid chunk type:"+e.type);var i=String.fromCharCode(t[n++],t[n++],t[n++],t[n++]);if("INFO"!==i)throw new Error("invalid signature:"+i);new s(t,{index:n,length:e.size-4}).parse()}parseSdtaList(e){var t=this.input,n=e.offset;if("LIST"!==e.type)throw new Error("invalid chunk type:"+e.type);var i=String.fromCharCode(t[n++],t[n++],t[n++],t[n++]);if("sdta"!==i)throw new Error("invalid signature:"+i);var r=new s(t,{index:n,length:e.size-4});if(r.parse(),1!==r.chunkList.length)throw new Error("TODO");this.samplingData=r.getChunk(0)}parsePdtaList(e){var t=this.input,n=e.offset;if("LIST"!==e.type)throw new Error("invalid chunk type:"+e.type);var i=String.fromCharCode(t[n++],t[n++],t[n++],t[n++]);if("pdta"!==i)throw new Error("invalid signature:"+i);var r=new s(t,{index:n,length:e.size-4});if(r.parse(),9!==r.getNumberOfChunks())throw new Error("invalid pdta chunk");this.parsePhdr(r.getChunk(0)),this.parsePbag(r.getChunk(1)),this.parsePmod(r.getChunk(2)),this.parsePgen(r.getChunk(3)),this.parseInst(r.getChunk(4)),this.parseIbag(r.getChunk(5)),this.parseImod(r.getChunk(6)),this.parseIgen(r.getChunk(7)),this.parseShdr(r.getChunk(8))}parsePhdr(e){var t=this.input,n=e.offset,i=this.presetHeader=[],s=e.offset+e.size;if("phdr"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;n<s;)i.push({presetName:String.fromCharCode.apply(null,t.subarray(n,n+=20)),preset:t[n++]|t[n++]<<8,bank:t[n++]|t[n++]<<8,presetBagIndex:t[n++]|t[n++]<<8,library:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,genre:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,morphology:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0})}parsePbag(e){var t=this.input,n=e.offset,i=this.presetZone=[],s=e.offset+e.size;if("pbag"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;n<s;)i.push({presetGeneratorIndex:t[n++]|t[n++]<<8,presetModulatorIndex:t[n++]|t[n++]<<8})}parsePmod(e){if("pmod"!==e.type)throw new Error("invalid chunk type:"+e.type);this.presetZoneModulator=this.parseModulator(e)}parsePgen(e){if("pgen"!==e.type)throw new Error("invalid chunk type:"+e.type);this.presetZoneGenerator=this.parseGenerator(e)}parseInst(e){var t=this.input,n=e.offset,i=this.instrument=[],s=e.offset+e.size;if("inst"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;n<s;)i.push({instrumentName:String.fromCharCode.apply(null,t.subarray(n,n+=20)),instrumentBagIndex:t[n++]|t[n++]<<8})}parseIbag(e){var t=this.input,n=e.offset,i=this.instrumentZone=[],s=e.offset+e.size;if("ibag"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;n<s;)i.push({instrumentGeneratorIndex:t[n++]|t[n++]<<8,instrumentModulatorIndex:t[n++]|t[n++]<<8})}parseImod(e){if("imod"!==e.type)throw new Error("invalid chunk type:"+e.type);this.instrumentZoneModulator=this.parseModulator(e)}parseIgen(e){if("igen"!==e.type)throw new Error("invalid chunk type:"+e.type);this.instrumentZoneGenerator=this.parseGenerator(e)}parseShdr(e){var t,n,i,s,r,a,o,h,l,u,c=this.input,d=e.offset,p=this.sample=[],m=this.sampleHeader=[],f=e.offset+e.size;if("shdr"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;d<f;){t=String.fromCharCode.apply(null,c.subarray(d,d+=20)),n=(c[d++]<<0|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0,i=(c[d++]<<0|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0,s=(c[d++]<<0|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0,r=(c[d++]<<0|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0,a=(c[d++]<<0|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0,o=c[d++],h=c[d++]<<24>>24,l=c[d++]|c[d++]<<8,u=c[d++]|c[d++]<<8;var v=new Int16Array(new Uint8Array(c.subarray(this.samplingData.offset+2*n,this.samplingData.offset+2*i)).buffer);if(s-=n,r-=n,a>0){var g=this.adjustSampleData(v,a);v=g.sample,a*=g.multiply,s*=g.multiply,r*=g.multiply}p.push(v),m.push({sampleName:t,start:n,end:i,startLoop:s,endLoop:r,sampleRate:a,originalPitch:o,pitchCorrection:h,sampleLink:l,sampleType:u})}}adjustSampleData(e,t){for(var n,i,s,r,a=1;t<this.sampleRate;){for(n=new Int16Array(2*e.length),i=r=0,s=e.length;i<s;++i)n[r++]=e[i],n[r++]=e[i];e=n,a*=2,t*=2}return{sample:e,multiply:a}}parseModulator(e){for(var t,n,i=this.input,s=e.offset,r=e.offset+e.size,a=[];s<r;){if(s+=2,t=i[s++]|i[s++]<<8,void 0===(n=this.GeneratorEnumeratorTable[t]))a.push({type:n,value:{code:t,amount:i[s]|i[s+1]<<8<<16>>16,lo:i[s++],hi:i[s++]}});else switch(n){case"keyRange":case"velRange":case"keynum":case"velocity":a.push({type:n,value:{lo:i[s++],hi:i[s++]}});break;default:a.push({type:n,value:{amount:i[s++]|i[s++]<<8<<16>>16}})}s+=2,s+=2}return a}parseGenerator(e){for(var t,n,i=this.input,s=e.offset,r=e.offset+e.size,a=[];s<r;)if(t=i[s++]|i[s++]<<8,void 0!==(n=this.GeneratorEnumeratorTable[t]))switch(n){case"keynum":case"keyRange":case"velRange":case"velocity":a.push({type:n,value:{lo:i[s++],hi:i[s++]}});break;default:a.push({type:n,value:{amount:i[s++]|i[s++]<<8<<16>>16}})}else a.push({type:n,value:{code:t,amount:i[s]|i[s+1]<<8<<16>>16,lo:i[s++],hi:i[s++]}});return a}createInstrument(){var e,t,n,i,s,r,a,o=this.instrument,h=this.instrumentZone,l=[];for(i=0,s=o.length;i<s;++i){for(e=[],r=o[i].instrumentBagIndex,a=o[i+1]?o[i+1].instrumentBagIndex:h.length;r<a;++r)t=this.createInstrumentGenerator_(h,r),n=this.createInstrumentModulator_(h,r),e.push({generator:t.generator,generatorSequence:t.generatorInfo,modulator:n.modulator,modulatorSequence:n.modulatorInfo});l.push({name:o[i].instrumentName,info:e})}return l}createPreset(){var e,t,n,i,s,r,a,o,h=this.presetHeader,l=this.presetZone,u=[];for(s=0,r=h.length;s<r;++s){for(e=[],a=h[s].presetBagIndex,o=h[s+1]?h[s+1].presetBagIndex:l.length;a<o;++a)n=this.createPresetGenerator_(l,a),i=this.createPresetModulator_(l,a),e.push({generator:n.generator,generatorSequence:n.generatorInfo,modulator:i.modulator,modulatorSequence:i.modulatorInfo}),t=void 0!==n.generator.instrument?n.generator.instrument.amount:void 0!==i.modulator.instrument?i.modulator.instrument.amount:null;u.push({name:h[s].presetName,info:e,header:h[s],instrument:t})}return u}createInstrumentGenerator_(e,t){var n=this.createBagModGen_(e,e[t].instrumentGeneratorIndex,e[t+1]?e[t+1].instrumentGeneratorIndex:this.instrumentZoneGenerator.length,this.instrumentZoneGenerator);return{generator:n.modgen,generatorInfo:n.modgenInfo}}createInstrumentModulator_(e,t){var n=this.createBagModGen_(e,e[t].presetModulatorIndex,e[t+1]?e[t+1].instrumentModulatorIndex:this.instrumentZoneModulator.length,this.instrumentZoneModulator);return{modulator:n.modgen,modulatorInfo:n.modgenInfo}}createPresetGenerator_(e,t){var n=this.createBagModGen_(e,e[t].presetGeneratorIndex,e[t+1]?e[t+1].presetGeneratorIndex:this.presetZoneGenerator.length,this.presetZoneGenerator);return{generator:n.modgen,generatorInfo:n.modgenInfo}}createPresetModulator_(e,t){var n=this.createBagModGen_(e,e[t].presetModulatorIndex,e[t+1]?e[t+1].presetModulatorIndex:this.presetZoneModulator.length,this.presetZoneModulator);return{modulator:n.modgen,modulatorInfo:n.modgenInfo}}createBagModGen_(e,t,n,i){var s,r,a,o=[],h={unknown:[],keyRange:{hi:127,lo:0}};for(r=t,a=n;r<a;++r)s=i[r],o.push(s),"unknown"===s.type?h.unknown.push(s.value):h[s.type]=s.value;return{modgen:h,modgenInfo:o}}}class o{constructor(t){var n,i;for(this.input=t,this.parser={},this.bank=0,this.bankSet={},this.bufferSize=2048,this.ctx=this.getAudioContext(),this.gainMaster=this.ctx.createGain(),this.bufSrc=this.ctx.createBufferSource(),this.channelInstrument=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.channelBank=[0,0,0,0,0,0,0,0,0,0,0,127,0,0,0,0],this.channelVolume=[127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127],this.channelPanpot=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelPitchBend=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.channelPitchBendSensitivity=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],this.channelExpression=[127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127],this.channelAttack=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelDecay=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelSustin=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelRelease=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelHold=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.channelHarmonicContent=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelCutOffFrequency=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.isGS=!1,this.isXG=!1,this.programSet=[],this.channelMute=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.currentNoteOn=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],this.baseVolume=1/65535,this.masterVolume=16384,this.percussionPart=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1],this.percussionVolume=new Array(128),n=0,i=this.percussionVolume.length;n<i;++n)this.percussionVolume[n]=127;for(this.programSet={},this.reverb=[],this.filter=[],n=0;n<16;++n)this.reverb[n]=new e(this.ctx,{mix:.315}),this.filter[n]=this.ctx.createBiquadFilter()}getAudioContext(){var e=new(window.AudioContext||window.webkitAudioContext);e.createGain=e.createGain||e.createGainNode;var t=()=>{document.removeEventListener("touchstart",t);var n=e.createBufferSource();n.start(),n.stop()};return document.addEventListener("touchstart",t),e}init(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"GM";for(this.gainMaster.disconnect(),this.parser=new a(this.input,{sampleRate:this.ctx.sampleRate}),this.bankSet=this.createAllInstruments(),this.isXG=!1,this.isGS=!1,"XG"==t?this.isXG=!0:"GS"==t&&(this.isGS=!0),e=0;e<16;++e)this.programChange(e,0),this.volumeChange(e,100),this.panpotChange(e,64),this.pitchBend(e,0,64),this.pitchBendSensitivity(e,2),this.channelHold[e]=!1,this.channelExpression[e]=127,this.channelBank[e]=9===e?127:0,this.attackTime(e,64),this.decayTime(e,64),this.sustinTime(e,64),this.releaseTime(e,64),this.harmonicContent(e,64),this.cutOffFrequency(e,64),this.reverbDepth(e,40),this.updateBankSelect(e),this.updateProgramSelect(e);for(this.setPercussionPart(9,!0),e=0;e<128;++e)this.percussionVolume[e]=127;this.gainMaster.connect(this.ctx.destination)}close(){this.ctx.close()}refreshInstruments(e){this.input=e,this.parser=new a(e),this.bankSet=this.createAllInstruments()}createAllInstruments(){var e=this.parser;e.parse();var t,n,i,s,r,a,o,h,l,u,c=e.createPreset(),d=e.createInstrument(),p=[],m=[];for(a=0,o=c.length;a<o;++a)if(r=(i=c[a]).header.preset,n=i.header.bank,u=i.name.replace(/\0*$/,""),"number"==typeof i.instrument&&"EOI"!==(s=d[i.instrument]).name.replace(/\0*$/,"")){for(void 0===p[n]&&(p[n]=[]),(t=p[n])[r]={},t[r].name=u,h=0,l=s.info.length;h<l;++h)this.createNoteInfo(e,s.info[h],t[r]);m[n]||(m[n]={}),m[n][r]=u}return this.programSet=m,p}createNoteInfo(e,t,n){var i=t.generator;if(void 0!==i.keyRange&&void 0!==i.sampleID)for(var s=this.getModGenAmount(i,"delayVolEnv",-12e3),r=this.getModGenAmount(i,"attackVolEnv",-12e3),a=this.getModGenAmount(i,"holdVolEnv",-12e3),o=this.getModGenAmount(i,"decayVolEnv",-12e3),h=this.getModGenAmount(i,"sustainVolEnv"),l=this.getModGenAmount(i,"releaseVolEnv",-12e3),u=this.getModGenAmount(i,"delayModEnv",-12e3),c=this.getModGenAmount(i,"attackModEnv",-12e3),d=this.getModGenAmount(i,"holdModEnv",-12e3),p=this.getModGenAmount(i,"decayModEnv",-12e3),m=this.getModGenAmount(i,"sustainModEnv"),f=this.getModGenAmount(i,"releaseModEnv",-12e3),v=this.getModGenAmount(i,"scaleTuning",100)/100,g=this.getModGenAmount(i,"freqVibLFO"),y=this.getModGenAmount(i,"pan"),k=this.getModGenAmount(i,"coarseTune")+this.getModGenAmount(i,"fineTune")/100,b=i.keyRange.lo,S=i.keyRange.hi;b<=S;++b)if(!n[b]){var A=this.getModGenAmount(i,"sampleID"),M=e.sampleHeader[A];n[b]={sample:e.sample[A],sampleRate:M.sampleRate,sampleModes:this.getModGenAmount(i,"sampleModes"),basePlaybackRate:1.0594630943592953**((b-this.getModGenAmount(i,"overridingRootKey",M.originalPitch)+k+M.pitchCorrection/100)*v),modEnvToPitch:this.getModGenAmount(i,"modEnvToPitch")/100,scaleTuning:v,start:32768*this.getModGenAmount(i,"startAddrsCoarseOffset")+this.getModGenAmount(i,"startAddrsOffset"),end:32768*this.getModGenAmount(i,"endAddrsCoarseOffset")+this.getModGenAmount(i,"endAddrsOffset"),loopStart:M.startLoop+32768*this.getModGenAmount(i,"startloopAddrsCoarseOffset")+this.getModGenAmount(i,"startloopAddrsOffset"),loopEnd:M.endLoop+32768*this.getModGenAmount(i,"endloopAddrsCoarseOffset")+this.getModGenAmount(i,"endloopAddrsOffset"),volDelay:2**(s/1200),volAttack:2**(r/1200),volHold:2**(a/1200)*2**((60-b)*this.getModGenAmount(i,"keynumToVolEnvHold")/1200),volDecay:2**(o/1200)*2**((60-b)*this.getModGenAmount(i,"keynumToVolEnvDecay")/1200),volSustain:h/1e3,volRelease:2**(l/1200),modDelay:2**(u/1200),modAttack:2**(c/1200),modHold:2**(d/1200)*2**((60-b)*this.getModGenAmount(i,"keynumToModEnvHold")/1200),modDecay:2**(p/1200)*2**((60-b)*this.getModGenAmount(i,"keynumToModEnvDecay")/1200),modSustain:m/1e3,modRelease:2**(f/1200),initialFilterFc:this.getModGenAmount(i,"initialFilterFc",13500),modEnvToFilterFc:this.getModGenAmount(i,"modEnvToFilterFc"),initialFilterQ:this.getModGenAmount(i,"initialFilterQ"),reverbEffectSend:this.getModGenAmount(i,"reverbEffectSend"),initialAttenuation:this.getModGenAmount(i,"initialAttenuation"),freqVibLFO:g?2**(g/1200)*8.176:void 0,pan:y?y/1200:void 0}}}getModGenAmount(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return e[t]?e[t].amount:n}start(){this.connect(),this.bufSrc.start(0),this.setMasterVolume(16383)}setMasterVolume(e){this.masterVolume=e,this.gainMaster.gain.value=this.baseVolume*(e/16384)}connect(){this.bufSrc.connect(this.gainMaster)}disconnect(){this.bufSrc.disconnect(this.gainMaster),this.bufSrc.buffer=null}noteOn(e,t,n){var s,r=this.channelBank[e],a="object"==typeof this.bankSet[r]?this.bankSet[r]:this.bankSet[0];if(void 0!==(s="object"==typeof a[this.channelInstrument[e]]?a[this.channelInstrument[e]]:1==this.percussionPart[e]?this.bankSet[this.isXG?127:128][0]:this.bankSet[0][this.channelInstrument[e]])[t]){var o=s[t],h=0===this.channelPanpot[e]?127*Math.random()|0:this.channelPanpot[e]-64;h/=h<0?64:63,o.channel=e,o.key=t,o.velocity=n,o.panpot=h,o.volume=this.channelVolume[e]/127,o.pitchBend=this.channelPitchBend[e]-8192,o.expression=this.channelExpression[e],o.pitchBendSensitivity=Math.round(this.channelPitchBendSensitivity[e]),o.mute=this.channelMute[e],o.releaseTime=this.channelRelease[e],o.cutOffFrequency=this.cutOffFrequency[e],o.harmonicContent=this.harmonicContent[e],o.reverb=this.reverb[e],r>125&&(42!==t&&44!==t||this.noteOff(e,46,0),80===t&&this.noteOff(e,81,0),s.volume*=this.percussionVolume[t]/127);var l=new i(this.ctx,this.gainMaster,o);l.noteOn(),this.currentNoteOn[e].push(l),this.updateSynthElement(e,t,n)}else console.warn("instrument not found: bank=%s instrument=%s channel=%s key=%s",r,this.channelInstrument[e],e,t)}noteOff(e,t,n){var i,s,r,a=this.currentNoteOn[e],o=this.channelHold[e];for(i=0,s=a.length;i<s;++i)(r=a[i]).key===t&&(r.noteOff(),o||(r.release(),a.splice(i,1),--i,--s));this.updateSynthElement(e,t,0)}hold(e,t){var n,i,s,r=this.currentNoteOn[e];if(!(this.channelHold[e]=!(t<64)))for(i=0,s=r.length;i<s;++i)(n=r[i]).isNoteOff()&&(n.release(),r.splice(i,1),--i,--s);if(this.element){var a=this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+")");this.channelHold[e]?a.classList.add("hold"):a.classList.remove("hold")}}bankSelectMsb(e,t){if(this.isXG)this.channelBank[e]=0,64===t?(this.channelBank[e]=125,this.percussionPart[e]=!0):126!==t&&127!==t||(this.channelBank[e]=t,this.percussionPart[e]=!0);else{if(!this.isGS)return;this.channelBank[e]=9===e?128:t,this.percussionPart[e]=128===t}this.updateBankSelect(e)}bankSelectLsb(e,t){this.isXG&&!0!==this.percussionPart[e]&&(this.percussionPart[e]=t>=125,this.channelBank[e]=t,this.updateBankSelect(e))}programChange(e,t){this.channelInstrument[e]=t,this.bankChange(e,this.channelBank[e]),this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") .program > select").value=t)}bankChange(e,t){"object"==typeof this.bankSet[t]?this.channelBank[e]=t:this.percussionPart[e]?this.channelBank[e]=this.isXG?127:128:this.channelBank[e]=0,this.updateProgramSelect(e),this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .bank > select").value=t)}volumeChange(e,t){this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .volume var").innerText=t),this.channelVolume[e]=t}expression(e,t){var n,i,s=this.currentNoteOn[e];for(n=0,i=s.length;n<i;++n)s[n].updateExpression(t);this.channelExpression[e]=t}panpotChange(e,t){this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .panpot > meter").value=t),this.channelPanpot[e]=t}pitchBend(e,t,n){var i,s,r=127&t|(127&n)<<7,a=this.currentNoteOn[e],o=r-8192;for(this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .pitchBend > meter").value=o),i=0,s=a.length;i<s;++i)a[i].updatePitchBend(o);this.channelPitchBend[e]=r}pitchBendSensitivity(e,t){this.element&&(document.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .pitchBendSensitivity > var").innerText=t),this.channelPitchBendSensitivity[e]=t}attackTime(e,t){this.channelAttack[e]=t}decayTime(e,t){this.channelDecay[e]=t}sustinTime(e,t){this.channelSustin[e]=t}releaseTime(e,t){this.channelRelease[e]=t}harmonicContent(e,t){this.channelHarmonicContent[e]=t}cutOffFrequency(e,t){this.channelCutOffFrequency[e]=t}reverbDepth(e,t){this.reverb[e].mix(t/127)}modulationDepth(e,t){}getPitchBendSensitivity(e){return this.channelPitchBendSensitivity[e]}drumInstrumentLevel(e,t){this.percussionVolume[e]=t}allNoteOff(e){var t=this.currentNoteOn[e];for(this.hold(e,0);t.length>0;)this.noteOff(e,t[0].key,0)}allSoundOff(e){for(var t,n=this.currentNoteOn[e];n.length>0;)t=n.shift(),this.noteOff(e,t.key,0),t.release(),t.disconnect();this.hold(e,0)}resetAllControl(e){this.allNoteOff(e),this.expression(e,127),this.pitchBend(e,0,64)}mute(e,t){var n,i,s=this.currentNoteOn[e];if(this.channelMute[e]=t,t)for(n=0,i=s.length;n<i;++n)s[n].disconnect();else for(n=0,i=s.length;n<i;++n)s[n].connect()}setPercussionPart(e,t){this.isXG?this.channelBank[e]=127:this.channelBank[e]=128,this.percussionPart[e]=t}}function h(){return(h=n((function*(e){var t=yield fetch(e);if(!t.ok)throw new Error("Did not get an OK response when fetching resource.");return yield t.arrayBuffer()}))).apply(this,arguments)}export default class{constructor(){this.synth=void 0,this._channel=0,this._bankIndex=0,this._programIndex=0}set channel(e){this._channel=e}loadSoundFontFromFile(e){var t=this;return n((function*(){var n=yield function(e){return new Promise((t,n)=>{var i=new FileReader;i.onload=()=>t(i.result),i.onerror=e=>n(e),i.readAsArrayBuffer(e)})}(e);t.bootSynth(n)}))()}loadSoundFontFromURL(e){var t=this;return n((function*(){var n=yield function(e){return h.apply(this,arguments)}(e);t.bootSynth(n)}))()}set bank(e){this._bankIndex=e,this.synth.bankChange(this._channel,e)}get banks(){return Object.keys(this.synth.programSet).map(e=>({id:e,name:("000"+parseInt(e,10)).slice(-3)}))}set program(e){this._programIndex=e,this.synth.programChange(this._channel,e)}get programs(){var{programSet:e}=this.synth;return Object.keys(e[this._bankIndex]).map(t=>({id:t,name:("000"+(parseInt(t)+1)).slice(-3)+":"+e[this._bankIndex][t]}))}bootSynth(e){var t=this;return n((function*(){var n,i=new Uint8Array(e);t.synth?t.synth.refreshInstruments(i):(t.synth=new o(i),t.synth.init(),t.synth.start(),yield(n=t.synth.programSet,new Promise(e=>{var t=setInterval(()=>{void 0!==n&&(clearInterval(t),e())},16)})),console.log(t.synth),console.log(t.banks),console.log(t.programs))}))()}noteOn(e){this.synth.noteOn(this._channel,e,127)}noteOff(e){this.synth.noteOff(this._channel,e,127)}}
//# sourceMappingURL=index.bundled.js.map

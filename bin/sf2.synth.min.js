/*! sf2synth.js | imaya / GREE Inc. / Logue | license: MIT */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("SoundFont",[],t):"object"==typeof exports?exports.SoundFont=t():e.SoundFont=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){"use strict";n.r(t);class s{constructor(e,t={}){this.input=e,this.ip=t.index||0,this.length=t.length||e.length-this.ip,this.chunkList,this.offset=this.ip,this.padding=void 0===t.padding||t.padding,this.bigEndian=void 0!==t.bigEndian&&t.bigEndian}parse(){let e=this.length+this.offset;for(this.chunkList=[];this.ip<e;)this.parseChunk()}parseChunk(){let e,t=this.input,n=this.ip;this.chunkList.push(new i(String.fromCharCode(t[n++],t[n++],t[n++],t[n++]),e=this.bigEndian?(t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++])>>>0:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,n)),n+=e,this.padding&&1==(n-this.offset&1)&&n++,this.ip=n}getChunk(e){let t=this.chunkList[e];return void 0===t?null:t}getNumberOfChunks(){return this.chunkList.length}}class i{constructor(e,t,n){this.type=e,this.size=t,this.offset=n}}n.d(t,"Parser",function(){return a});class a{constructor(e,t={}){this.input=e,this.parserOption=t.parserOption,this.sampleRate=t.sampleRate||22050,this.presetHeader,this.presetZone,this.presetZoneModulator,this.presetZoneGenerator,this.instrument,this.instrumentZone,this.instrumentZoneModulator,this.instrumentZoneGenerator,this.sampleHeader,this.GeneratorEnumeratorTable=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",,"chorusEffectsSend","reverbEffectsSend","pan",,,,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",,"scaleTuning","exclusiveClass","overridingRootKey","endOper"]}parse(){let e,t=new s(this.input,this.parserOption);if(t.parse(),1!==t.chunkList.length)throw new Error("wrong chunk length");if(null===(e=t.getChunk(0)))throw new Error("chunk not found");this.parseRiffChunk(e),this.input=null}parseRiffChunk(e){let t,n,i=this.input,a=e.offset;if("RIFF"!==e.type)throw new Error("invalid chunk type:"+e.type);if("sfbk"!==(n=String.fromCharCode(i[a++],i[a++],i[a++],i[a++])))throw new Error("invalid signature:"+n);if((t=new s(i,{index:a,length:e.size-4})).parse(),3!==t.getNumberOfChunks())throw new Error("invalid sfbk structure");this.parseInfoList(t.getChunk(0)),this.parseSdtaList(t.getChunk(1)),this.parsePdtaList(t.getChunk(2))}parseInfoList(e){let t,n,i=this.input,a=e.offset;if("LIST"!==e.type)throw new Error("invalid chunk type:"+e.type);if("INFO"!==(n=String.fromCharCode(i[a++],i[a++],i[a++],i[a++])))throw new Error("invalid signature:"+n);(t=new s(i,{index:a,length:e.size-4})).parse()}parseSdtaList(e){let t,n,i=this.input,a=e.offset;if("LIST"!==e.type)throw new Error("invalid chunk type:"+e.type);if("sdta"!==(n=String.fromCharCode(i[a++],i[a++],i[a++],i[a++])))throw new Error("invalid signature:"+n);if((t=new s(i,{index:a,length:e.size-4})).parse(),1!==t.chunkList.length)throw new Error("TODO");this.samplingData=t.getChunk(0)}parsePdtaList(e){let t,n,i=this.input,a=e.offset;if("LIST"!==e.type)throw new Error("invalid chunk type:"+e.type);if("pdta"!==(n=String.fromCharCode(i[a++],i[a++],i[a++],i[a++])))throw new Error("invalid signature:"+n);if((t=new s(i,{index:a,length:e.size-4})).parse(),9!==t.getNumberOfChunks())throw new Error("invalid pdta chunk");this.parsePhdr(t.getChunk(0)),this.parsePbag(t.getChunk(1)),this.parsePmod(t.getChunk(2)),this.parsePgen(t.getChunk(3)),this.parseInst(t.getChunk(4)),this.parseIbag(t.getChunk(5)),this.parseImod(t.getChunk(6)),this.parseIgen(t.getChunk(7)),this.parseShdr(t.getChunk(8))}parsePhdr(e){let t=this.input,n=e.offset,s=this.presetHeader=[],i=e.offset+e.size;if("phdr"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;n<i;)s.push({presetName:String.fromCharCode.apply(null,t.subarray(n,n+=20)),preset:t[n++]|t[n++]<<8,bank:t[n++]|t[n++]<<8,presetBagIndex:t[n++]|t[n++]<<8,library:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,genre:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0,morphology:(t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24)>>>0})}parsePbag(e){let t=this.input,n=e.offset,s=this.presetZone=[],i=e.offset+e.size;if("pbag"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;n<i;)s.push({presetGeneratorIndex:t[n++]|t[n++]<<8,presetModulatorIndex:t[n++]|t[n++]<<8})}parsePmod(e){if("pmod"!==e.type)throw new Error("invalid chunk type:"+e.type);this.presetZoneModulator=this.parseModulator(e)}parsePgen(e){if("pgen"!==e.type)throw new Error("invalid chunk type:"+e.type);this.presetZoneGenerator=this.parseGenerator(e)}parseInst(e){let t=this.input,n=e.offset,s=this.instrument=[],i=e.offset+e.size;if("inst"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;n<i;)s.push({instrumentName:String.fromCharCode.apply(null,t.subarray(n,n+=20)),instrumentBagIndex:t[n++]|t[n++]<<8})}parseIbag(e){let t=this.input,n=e.offset,s=this.instrumentZone=[],i=e.offset+e.size;if("ibag"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;n<i;)s.push({instrumentGeneratorIndex:t[n++]|t[n++]<<8,instrumentModulatorIndex:t[n++]|t[n++]<<8})}parseImod(e){if("imod"!==e.type)throw new Error("invalid chunk type:"+e.type);this.instrumentZoneModulator=this.parseModulator(e)}parseIgen(e){if("igen"!==e.type)throw new Error("invalid chunk type:"+e.type);this.instrumentZoneGenerator=this.parseGenerator(e)}parseShdr(e){let t,n,s,i,a,r,o,h,l,c,u=this.input,d=e.offset,p=this.sample=[],m=this.sampleHeader=[],f=e.offset+e.size;if("shdr"!==e.type)throw new Error("invalid chunk type:"+e.type);for(;d<f;){t=String.fromCharCode.apply(null,u.subarray(d,d+=20)),n=(u[d++]<<0|u[d++]<<8|u[d++]<<16|u[d++]<<24)>>>0,s=(u[d++]<<0|u[d++]<<8|u[d++]<<16|u[d++]<<24)>>>0,i=(u[d++]<<0|u[d++]<<8|u[d++]<<16|u[d++]<<24)>>>0,a=(u[d++]<<0|u[d++]<<8|u[d++]<<16|u[d++]<<24)>>>0,r=(u[d++]<<0|u[d++]<<8|u[d++]<<16|u[d++]<<24)>>>0,o=u[d++],h=u[d++]<<24>>24,l=u[d++]|u[d++]<<8,c=u[d++]|u[d++]<<8;let e=new Int16Array(new Uint8Array(u.subarray(this.samplingData.offset+2*n,this.samplingData.offset+2*s)).buffer);if(i-=n,a-=n,r>0){let t=this.adjustSampleData(e,r);e=t.sample,r*=t.multiply,i*=t.multiply,a*=t.multiply}p.push(e),m.push({sampleName:t,start:n,end:s,startLoop:i,endLoop:a,sampleRate:r,originalPitch:o,pitchCorrection:h,sampleLink:l,sampleType:c})}}adjustSampleData(e,t){let n,s,i,a,r=1;for(;t<this.sampleRate;){for(n=new Int16Array(2*e.length),s=a=0,i=e.length;s<i;++s)n[a++]=e[s],n[a++]=e[s];e=n,r*=2,t*=2}return{sample:e,multiply:r}}parseModulator(e){let t,n,s=this.input,i=e.offset,a=e.offset+e.size,r=[];for(;i<a;){if(i+=2,t=s[i++]|s[i++]<<8,void 0===(n=this.GeneratorEnumeratorTable[t]))r.push({type:n,value:{code:t,amount:s[i]|s[i+1]<<8<<16>>16,lo:s[i++],hi:s[i++]}});else switch(n){case"keyRange":case"velRange":case"keynum":case"velocity":r.push({type:n,value:{lo:s[i++],hi:s[i++]}});break;default:r.push({type:n,value:{amount:s[i++]|s[i++]<<8<<16>>16}})}i+=2,i+=2}return r}parseGenerator(e){let t,n,s=this.input,i=e.offset,a=e.offset+e.size,r=[];for(;i<a;)if(t=s[i++]|s[i++]<<8,void 0!==(n=this.GeneratorEnumeratorTable[t]))switch(n){case"keynum":case"keyRange":case"velRange":case"velocity":r.push({type:n,value:{lo:s[i++],hi:s[i++]}});break;default:r.push({type:n,value:{amount:s[i++]|s[i++]<<8<<16>>16}})}else r.push({type:n,value:{code:t,amount:s[i]|s[i+1]<<8<<16>>16,lo:s[i++],hi:s[i++]}});return r}createInstrument(){let e,t,n,s,i,a,r,o,h,l=this.instrument,c=this.instrumentZone,u=[];for(a=0,r=l.length;a<r;++a){for(n=[],o=e=l[a].instrumentBagIndex,h=t=l[a+1]?l[a+1].instrumentBagIndex:c.length;o<h;++o)s=this.createInstrumentGenerator_(c,o),i=this.createInstrumentModulator_(c,o),n.push({generator:s.generator,generatorSequence:s.generatorInfo,modulator:i.modulator,modulatorSequence:i.modulatorInfo});u.push({name:l[a].instrumentName,info:n})}return u}createPreset(){let e,t,n,s,i,a,r,o,h,l,c=this.presetHeader,u=this.presetZone,d=[];for(r=0,o=c.length;r<o;++r){for(n=[],h=e=c[r].presetBagIndex,l=t=c[r+1]?c[r+1].presetBagIndex:u.length;h<l;++h)i=this.createPresetGenerator_(u,h),a=this.createPresetModulator_(u,h),n.push({generator:i.generator,generatorSequence:i.generatorInfo,modulator:a.modulator,modulatorSequence:a.modulatorInfo}),s=void 0!==i.generator.instrument?i.generator.instrument.amount:void 0!==a.modulator.instrument?a.modulator.instrument.amount:null;d.push({name:c[r].presetName,info:n,header:c[r],instrument:s})}return d}createInstrumentGenerator_(e,t){let n=this.createBagModGen_(e,e[t].instrumentGeneratorIndex,e[t+1]?e[t+1].instrumentGeneratorIndex:this.instrumentZoneGenerator.length,this.instrumentZoneGenerator);return{generator:n.modgen,generatorInfo:n.modgenInfo}}createInstrumentModulator_(e,t){let n=this.createBagModGen_(e,e[t].presetModulatorIndex,e[t+1]?e[t+1].instrumentModulatorIndex:this.instrumentZoneModulator.length,this.instrumentZoneModulator);return{modulator:n.modgen,modulatorInfo:n.modgenInfo}}createPresetGenerator_(e,t){let n=this.createBagModGen_(e,e[t].presetGeneratorIndex,e[t+1]?e[t+1].presetGeneratorIndex:this.presetZoneGenerator.length,this.presetZoneGenerator);return{generator:n.modgen,generatorInfo:n.modgenInfo}}createPresetModulator_(e,t){let n=this.createBagModGen_(e,e[t].presetModulatorIndex,e[t+1]?e[t+1].presetModulatorIndex:this.presetZoneModulator.length,this.presetZoneModulator);return{modulator:n.modgen,modulatorInfo:n.modgenInfo}}createBagModGen_(e,t,n,s){let i,a,r,o=[],h={unknown:[],keyRange:{hi:127,lo:0}};for(a=t,r=n;a<r;++a)i=s[a],o.push(i),"unknown"===i.type?h.unknown.push(i.value):h[i.type]=i.value;return{modgen:h,modgenInfo:o}}}t.default=a},function(e,t,n){"use strict";n.r(t),n.d(t,"Reverb",function(){return s});class s{constructor(e,t){for(var n in this.ctx=e,this.wetGainNode=this.ctx.createGain(),this.dryGainNode=this.ctx.createGain(),this.node=this.ctx.createConvolver(),this.filterNode=this.ctx.createBiquadFilter(),this._cutOff=440,this._decay=1,this._delay=.5,this._filterType="bandpass",this._mix=.5,this._reverse=!1,this._time=1,t)void 0!==t[n]&&(this["_"+n]=t[n]);this.mix(this._mix),this.filterType(this._filterType),this.cutOff(this._cutOff),this.BuildImpulse(),this.node.connect(this.dryGainNode),this.node.connect(this.wetGainNode),this.node.connect(this.filterNode),this.dryGainNode.connect(this.node),this.wetGainNode.connect(this.node),this.filterNode.connect(this.node)}BuildImpulse(){const e=this.ctx.sampleRate,t=Math.max(e*this._time,1),n=e*this._delay;let s=this.ctx.createBuffer(2,t,e),i=new Float32Array(t),a=new Float32Array(t);for(var r=0;r<t;r++){let e=void 0,s=void 0;r<n?(i[r]=0,a[r]=0):(e=this._reverse?t-(r-n):r-n,e=this._reverse?t-r:r,s=Math.pow(1-e/t,this._decay),i[r]=(2*Math.random()-1)*s,a[r]=(2*Math.random()-1)*s),e=this._reverse?t-(r-n):r-n,s=Math.pow(1-e/t,this._decay),i[r]=(2*Math.random()-1)*s,a[r]=(2*Math.random()-1)*s}s.getChannelData(0).set(i),s.getChannelData(1).set(a),this.node.buffer=s}mix(e){this._mix=e,this.dryGainNode.gain.setTargetAtTime(this.getDryLevel(e)/127,this.ctx.currentTime,.015),this.wetGainNode.gain.setTargetAtTime(this.getWetLevel(e)/127,this.ctx.currentTime,.015)}time(e){this._time=e,this.BuildImpulse()}decay(e){this._decay=e,this.BuildImpulse()}delay(e){this._delay=e,this.BuildImpulse()}reverse(e){this._reverse=e,this.BuildImpulse()}cutOff(e){this._cutOff=e,this.filterNode.frequency.setTargetAtTime(this._cutOff,this.ctx.currentTime,.015)}filterType(e){this.filterNode.type=this._filterType=e}getDryLevel(e){return e>1||e<0?0:e<=.5?1:1-2*(e-.5)}getWetLevel(e){return e>1||e<0?0:e>=.5?1:1-2*(e-.5)}}t.default=s},function(e,t,n){"use strict";n.r(t);var s=class{constructor(e,t,n){this.ctx=e,this.destination=t,this.instrument=n,this.channel=n.channel,this.key=n.key,this.velocity=n.velocity,this.buffer=n.sample,this.playbackRate=n.basePlaybackRate,this.loopStart=n.loopStart,this.loopEnd=n.loopEnd,this.sampleRate=n.sampleRate,this.volume=n.volume,this.panpot=n.panpot,this.pitchBend=n.pitchBend,this.pitchBendSensitivity=n.pitchBendSensitivity,this.modEnvToPitch=n.modEnvToPitch,this.expression=n.expression,this.cutOffFrequency=n.cutOffFrequency,this.hermonicContent=n.hermonicContent,this.startTime=e.currentTime,this.computedPlaybackRate=0|this.playbackRate,this.noteOffState=!1,this.audioBuffer,this.bufferSource,this.panner,this.gainOutput,this.expressionGain,this.filter,this.modulator}noteOn(){var e,t,n,s,i,a,r,o,h,l,c=this.ctx,u=this.instrument,d=this.buffer,p=this.ctx.currentTime,m=p+u.volDelay,f=p+u.modDelay,g=m+u.volAttack,v=m+u.modAttack,y=g+u.volHold,k=v+u.modHold,b=y+u.volDecay,M=k+u.modDecay,w=u.loopStart/this.sampleRate,S=u.loopEnd/this.sampleRate,T=u.start/this.sampleRate,E=void 0!==u.pan?u.pan:this.panpot;u.cutOffFrequency,u.harmonicContent,d=d.subarray(0,d.length+u.end),(e=this.audioBuffer=c.createBuffer(1,d.length,this.sampleRate)).getChannelData(0).set(d),(t=this.bufferSource=c.createBufferSource()).buffer=e,t.loop=u.sampleModes,t.loopStart=w,t.loopEnd=S,this.updatePitchBend(this.pitchBend),a=(i=this.gainOutput=c.createGain()).gain,this.expressionGain=c.createGain(),this.expressionGain.gain.setTargetAtTime(this.expression/127,this.ctx.currentTime,.015),(s=this.panner=c.createPanner()).panningModel="equalpower",s.setPosition(Math.sin(E*Math.PI/2),0,Math.cos(E*Math.PI/2)),(l=this.volume*(this.velocity/127)*(1-u.initialAttenuation/1e3))<0&&(l=0),a.setValueAtTime(0,p).setValueAtTime(0,m).setTargetAtTime(l,m,u.volAttack).setValueAtTime(l,y).linearRampToValueAtTime(l*(1-u.volSustain),b),h=(r=this.amountToFreq(u.initialFilterFc))+((o=this.amountToFreq(u.initialFilterFc+u.modEnvToFilterFc))-r)*(1-u.modSustain),(n=this.modulator=c.createBiquadFilter()).Q.setValueAtTime(Math.pow(10,u.initialFilterQ/200),p),n.frequency.setTargetAtTime(r/127,this.ctx.currentTime,.5),n.type="lowpass",n.frequency.setValueAtTime(r,p).setValueAtTime(r,f).setTargetAtTime(o,f,parseFloat(u.modAttack+1)).setValueAtTime(o,k).linearRampToValueAtTime(h,M),t.connect(n),n.connect(s),s.connect(this.expressionGain),this.expressionGain.connect(i),u.mute||this.connect(),t.start(0,T)}amountToFreq(e){return 440*Math.pow(2,(e-6900)/1200)}noteOff(){this.noteOffState=!0}isNoteOff(){return this.noteOffState}release(){var e=this.instrument,t=this.bufferSource,n=this.gainOutput,s=this.ctx.currentTime,i=e.releaseTime-64,a=s+e.volRelease*n.gain.value*(1+i/(i<0?64:63)),r=this.modulator,o=this.amountToFreq(e.initialFilterFc),h=this.amountToFreq(e.initialFilterFc+e.modEnvToFilterFc),l=s+e.modRelease*(o===h?1:(r.frequency.value-o)/(h-o));if(this.audioBuffer)switch(e.sampleModes){case 0:break;case 1:n.gain.cancelScheduledValues(0),n.gain.setValueAtTime(n.gain.value,s),n.gain.linearRampToValueAtTime(0,a),r.frequency.cancelScheduledValues(0),r.frequency.setValueAtTime(r.frequency.value,s),r.frequency.linearRampToValueAtTime(o,l),t.playbackRate.cancelScheduledValues(0),t.playbackRate.setValueAtTime(t.playbackRate.value,s),t.playbackRate.linearRampToValueAtTime(this.computedPlaybackRate,l),t.stop(a);break;case 2:console.log("detect unused sampleModes");break;case 3:t.loop=!1}}connect(){this.gainOutput.connect(this.destination)}disconnect(){this.gainOutput.disconnect(0)}schedulePlaybackRate(){var e=this.bufferSource.playbackRate,t=this.computedPlaybackRate,n=this.startTime,s=this.instrument,i=n+s.modAttack,a=i+s.modDecay,r=t*Math.pow(Math.pow(2,1/12),this.modEnvToPitch*this.instrument.scaleTuning);e.cancelScheduledValues(0),e.setValueAtTime(t,n),e.linearRampToValueAtTime(r,i),e.linearRampToValueAtTime(t+(r-t)*(1-s.modSustain),a)}updateExpression(e){this.expressionGain.gain.setTargetAtTime((this.expression=e)/127,this.ctx.currentTime,.015)}updatePitchBend(e){this.computedPlaybackRate=this.playbackRate*Math.pow(Math.pow(2,1/12),e/(e<0?8192:8191)*this.pitchBendSensitivity*this.instrument.scaleTuning),this.schedulePlaybackRate()}},i=n(0),a=n(1);var r=class{constructor(e){var t,n;for(this.input=e,this.parser={},this.bank=0,this.bankSet={},this.bufferSize=2048,this.ctx=this.getAudioContext(),this.gainMaster=this.ctx.createGain(),this.bufSrc=this.ctx.createBufferSource(),this.channelInstrument=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.channelBank=[0,0,0,0,0,0,0,0,0,0,0,127,0,0,0,0],this.channelVolume=[127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127],this.channelPanpot=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelPitchBend=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.channelPitchBendSensitivity=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],this.channelExpression=[127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127],this.channelAttack=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelDecay=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelSustin=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelRelease=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelHold=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.channelReverbDepth=[40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40],this.channelHarmonicContent=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.channelCutOffFrequency=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],this.isGS=!1,this.isXG=!1,this.channelMute=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.currentNoteOn=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],this.baseVolume=1/65535,this.masterVolume=16384,this.percussionPart=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1],this.percussionVolume=new Array(128),t=0,n=this.percussionVolume.length;t<n;++t)this.percussionVolume[t]=127;this.programSet={},this.useReverb=!0,this.reverb=new a.default(this.ctx)}getAudioContext(){const e=void 0!==document.ontouchend?"touchend":"mouseup",t=new(window.AudioContext||window.webkitAudioContext);return document.addEventListener(e,()=>{t.resume()}),void 0===t.createGainNode&&(t.createGainNode=t.createGain),t}init(e="GM"){var t;for(this.parser=new i.default(this.input,{sampleRate:this.ctx.sampleRate}),this.bankSet=this.createAllInstruments(),this.isXG=!1,this.isGS=!1,"XG"==e?this.isXG=!0:"GS"==e&&(this.isGS=!0),t=0;t<16;++t)this.programChange(t,0),this.volumeChange(t,100),this.panpotChange(t,64),this.pitchBend(t,0,64),this.pitchBendSensitivity(t,2),this.channelHold[t]=!1,this.channelExpression[t]=127,this.channelBank[t]=9===t?127:0,this.attackTime(t,64),this.decayTime(t,64),this.sustinTime(t,64),this.releaseTime(t,64),this.harmonicContent(t,64),this.cutOffFrequency(t,64),this.reverbDepth(t,40),this.updateBankSelect(t),this.updateProgramSelect(t);for(this.setPercussionPart(9,!0),t=0;t<128;++t)this.percussionVolume[t]=127;this.useReverb&&(this.reverb.node.disconnect(0),this.gainMaster.connect(this.reverb.node),this.reverb.node.connect(this.ctx.destination)),this.element}close(){this.ctx.close()}refreshInstruments(e){this.input=e,this.parser=new i.default(e),this.bankSet=this.createAllInstruments()}createAllInstruments(){var e=this.parser;e.parse();var t,n,s,i,a,r,o,h,l,c,u=e.createPreset(),d=e.createInstrument(),p=[],m=[];for(r=0,o=u.length;r<o;++r)if(a=(s=u[r]).header.preset,n=s.header.bank,c=s.name.replace(/\0*$/,""),"number"==typeof s.instrument&&"EOI"!==(i=d[s.instrument]).name.replace(/\0*$/,"")){for(void 0===p[n]&&(p[n]=[]),(t=p[n])[a]={},t[a].name=c,h=0,l=i.info.length;h<l;++h)this.createNoteInfo(e,i.info[h],t[a]);m[n]||(m[n]={}),m[n][a]=c}return this.programSet=m,p}createNoteInfo(e,t,n){var s,i,a,r,o,h,l,c,u,d,p,m,f,g,v,y,k,b,M,w,S=t.generator;if(void 0!==S.keyRange&&void 0!==S.sampleID)for(a=this.getModGenAmount(S,"delayVolEnv",-12e3),r=this.getModGenAmount(S,"attackVolEnv",-12e3),o=this.getModGenAmount(S,"holdVolEnv",-12e3),h=this.getModGenAmount(S,"decayVolEnv",-12e3),l=this.getModGenAmount(S,"sustainVolEnv"),c=this.getModGenAmount(S,"releaseVolEnv",-12e3),u=this.getModGenAmount(S,"delayModEnv",-12e3),d=this.getModGenAmount(S,"attackModEnv",-12e3),p=this.getModGenAmount(S,"holdModEnv",-12e3),m=this.getModGenAmount(S,"decayModEnv",-12e3),f=this.getModGenAmount(S,"sustainModEnv"),g=this.getModGenAmount(S,"releaseModEnv",-12e3),v=this.getModGenAmount(S,"coarseTune")+this.getModGenAmount(S,"fineTune")/100,y=this.getModGenAmount(S,"scaleTuning",100)/100,k=this.getModGenAmount(S,"freqVibLFO"),w=this.getModGenAmount(S,"pan"),b=S.keyRange.lo,M=S.keyRange.hi;b<=M;++b)n[b]||(s=this.getModGenAmount(S,"sampleID"),i=e.sampleHeader[s],n[b]={sample:e.sample[s],sampleRate:i.sampleRate,sampleModes:this.getModGenAmount(S,"sampleModes"),basePlaybackRate:Math.pow(Math.pow(2,1/12),(b-this.getModGenAmount(S,"overridingRootKey",i.originalPitch)+v+i.pitchCorrection/100)*y),modEnvToPitch:this.getModGenAmount(S,"modEnvToPitch")/100,scaleTuning:y,start:32768*this.getModGenAmount(S,"startAddrsCoarseOffset")+this.getModGenAmount(S,"startAddrsOffset"),end:32768*this.getModGenAmount(S,"endAddrsCoarseOffset")+this.getModGenAmount(S,"endAddrsOffset"),loopStart:i.startLoop+32768*this.getModGenAmount(S,"startloopAddrsCoarseOffset")+this.getModGenAmount(S,"startloopAddrsOffset"),loopEnd:i.endLoop+32768*this.getModGenAmount(S,"endloopAddrsCoarseOffset")+this.getModGenAmount(S,"endloopAddrsOffset"),volDelay:Math.pow(2,a/1200),volAttack:Math.pow(2,r/1200),volHold:Math.pow(2,o/1200)*Math.pow(2,(60-b)*this.getModGenAmount(S,"keynumToVolEnvHold")/1200),volDecay:Math.pow(2,h/1200)*Math.pow(2,(60-b)*this.getModGenAmount(S,"keynumToVolEnvDecay")/1200),volSustain:l/1e3,volRelease:Math.pow(2,c/1200),modDelay:Math.pow(2,u/1200),modAttack:Math.pow(2,d/1200),modHold:Math.pow(2,p/1200)*Math.pow(2,(60-b)*this.getModGenAmount(S,"keynumToModEnvHold")/1200),modDecay:Math.pow(2,m/1200)*Math.pow(2,(60-b)*this.getModGenAmount(S,"keynumToModEnvDecay")/1200),modSustain:f/1e3,modRelease:Math.pow(2,g/1200),initialFilterFc:this.getModGenAmount(S,"initialFilterFc",13500),modEnvToFilterFc:this.getModGenAmount(S,"modEnvToFilterFc"),initialFilterQ:this.getModGenAmount(S,"initialFilterQ"),reverbEffectSend:this.getModGenAmount(S,"reverbEffectSend"),initialAttenuation:this.getModGenAmount(S,"initialAttenuation"),freqVibLFO:k?8.176*Math.pow(2,k/1200):void 0,pan:w?w/1200:void 0})}getModGenAmount(e,t,n){return void 0===n&&(n=0),e[t]?e[t].amount:n}start(){this.connect(),this.setMasterVolume(16383),this.bufSrc.start(0)}setMasterVolume(e){this.masterVolume=e,this.gainMaster.gain.setTargetAtTime(this.baseVolume*(e/16384),this.ctx.currentTime,.015)}connect(){this.setReverb(!0),this.bufSrc.connect(this.gainMaster),this.gainMaster.connect(this.ctx.destination)}disconnect(){this.setReverb(!1),this.bufSrc.disconnect(0),this.gainMaster.disconnect(0)}setReverb(e){this.useReverb=e,e?(this.gainMaster.connect(this.reverb.node),this.reverb.node.connect(this.ctx.destination)):this.reverb.node.disconnect(0)}reverbDepth(e,t){this.reverbDepth[e]=t}removeSynth(){this.ctx.close()}drawSynth(){const e=window.document,t=this.element=e.createElement("div"),n=e.createElement("div");n.className="instrument";const s=["mute","bank","program","volume","panpot","pitchBend","pitchBendSensitivity","keys"];let i,a;for(let t=0;t<16;t++){(i=e.createElement("div")).className="channel";for(let n in s){let r=e.createElement("div");switch(r.className=s[n],s[n]){case"mute":let i=document.createElement("div");i.className="custom-control custom-checkbox custom-control-inline";let o=e.createElement("input");o.setAttribute("type","checkbox"),o.className="custom-control-input",o.id="mute"+t+"ch",o.addEventListener("change",((e,t)=>()=>{e.mute(t,this.checked)})(this,t),!1),i.appendChild(o),(a=e.createElement("label")).className="custom-control-label",a.textContent=t+1,a.setAttribute("for","mute"+t+"ch"),i.appendChild(a),r.appendChild(i);break;case"bank":let h=e.createElement("select");h.className="form-control form-control-sm",r.appendChild(h);let l=e.createElement("option");h.appendChild(l),h.addEventListener("change",function(e,t){return function(n){e.bankChange(t,n.target.value),e.programChange(t,e.channelInstrument[t])}}(this,t),!1),h.selectedIndex=this.channelInstrument[n];break;case"program":let c=e.createElement("select");c.className="form-control form-control-sm",r.appendChild(c),c.addEventListener("change",function(e,t){return function(n){e.programChange(t,n.target.value)}}(this,t),!1),c.selectedIndex=this.channelInstrument[n];break;case"volume":r.innerText=100;case"pitchBendSensitivity":r.innerText=2;break;case"panpot":let u=e.createElement("meter");u.min=0,u.max=127,u.value=64,r.appendChild(u);break;case"pitchBend":let d=e.createElement("meter");d.min=-8192,d.max=8192,d.value=0,r.appendChild(d);break;case"keys":for(let n=0;n<127;n++){let s=e.createElement("div"),i=n%12;s.className="key "+([1,3,6,8,10].includes(i)?"semitone":"tone"),r.appendChild(s),s.addEventListener("mousedown",function(e,t,n){return function(s){s.preventDefault(),e.drag=!0,e.noteOn(t,n,127)}}(this,t,n)),s.addEventListener("mouseover",function(e,t,n){return function(s){s.preventDefault(),e.drag&&e.noteOn(t,n,127)}}(this,t,n)),s.addEventListener("mouseout",function(e,t,n){return function(s){s.preventDefault(),e.noteOff(t,n,0)}}(this,t,n)),s.addEventListener("mouseup",function(e,t,n){return function(s){s.preventDefault(),e.drag=!1,e.noteOff(t,n,0)}}(this,t,n))}}i.appendChild(r)}n.appendChild(i)}return t.appendChild(n),t}noteOn(e,t,n){var i,a,r=this.channelBank[e],o="object"==typeof this.bankSet[r]?this.bankSet[r]:this.bankSet[0],h="object"==typeof o[this.channelInstrument[e]]?o[this.channelInstrument[e]]:this.bankSet[0][this.channelInstrument[e]];if(void 0===h&&(h=r<125?this.bankSet[0][this.channelInstrument[e]]:this.bankSet[r][0]),void 0!==h[t]){i=h[t];var l=this.channelPanpot[e]-64;l/=l<0?64:63,i.channel=e,i.key=t,i.velocity=n,i.panpot=l,i.volume=this.channelVolume[e]/127,i.pitchBend=this.channelPitchBend[e]-8192,i.expression=this.channelExpression[e],i.pitchBendSensitivity=Math.round(this.channelPitchBendSensitivity[e]),i.mute=this.channelMute[e],i.releaseTime=this.channelRelease[e],i.cutOffFrequency=this.cutOffFrequency[e],i.harmonicContent=this.harmonicContent[e],r>125&&(42!==t&&44!==t||this.noteOff(e,46,0),80===t&&this.noteOff(e,81,0),h.volume*=this.percussionVolume[t]/127),(a=new s(this.ctx,this.gainMaster,i)).noteOn(),this.currentNoteOn[e].push(a),this.updateSynthElement(e,t,n)}else console.warn("instrument not found: bank=%s instrument=%s channel=%s key=%s",r,this.channelInstrument[e],e,t)}noteOff(e,t,n){var s,i,a,r=this.channelBank[e],o=(this.bankSet[r],this.currentNoteOn[e]),h=this.channelHold[e];for(s=0,i=o.length;s<i;++s)(a=o[s]).key===t&&(a.noteOff(),h||(a.release(),o.splice(s,1),--s,--i));this.updateSynthElement(e,t,0)}updateSynthElement(e,t,n){if(!this.element)return;const s=this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+")"),i=s.querySelector(".key:nth-child("+(t+1)+")");0===n?i.classList.remove("note-on"):i.classList.add("note-on"),this.channelHold[e]?s.classList.add("hold"):s.classList.remove("hold")}hold(e,t){var n,s,i,a=this.currentNoteOn[e];if(!(this.channelHold[e]=!(t<64)))for(s=0,i=a.length;s<i;++s)(n=a[s]).isNoteOff()&&(n.release(),a.splice(s,1),--s,--i)}bankSelectMsb(e,t){if(this.isXG)64===t?(this.channelBank[e]=125,this.percussionPart[e]=!0):126!==t&&127!==t||(this.channelBank[e]=t,this.percussionPart[e]=!0);else{if(!this.isGS)return;this.channelBank[e]=t,this.percussionPart[e]=128===t}this.updateBankSelect(e)}bankSelectLsb(e,t){this.isXG&&!0!==this.percussionPart[e]&&(this.percussionPart[e]=t>=125,this.channelBank[e]=t,this.updateBankSelect(e))}updateBankSelect(e){if(!this.element)return;const t=this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") .bank > select");for(;t.firstChild;)t.removeChild(t.firstChild);for(let e in this.programSet){let n=document.createElement("option");n.value=e,n.textContent=("000"+parseInt(e)).slice(-3),t.appendChild(n)}}updateProgramSelect(e){if(!this.element)return;var t=this.channelBank[e];const n=this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") .bank > select"),s=this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") .program > select");for(n.value=this.channelBank[e];s.firstChild;)s.removeChild(s.firstChild);for(let n in this.programSet[t]){let i=document.createElement("option");i.value=n,i.textContent=("000"+(parseInt(n)+1)).slice(-3)+":"+this.programSet[t][n],n===this.channelInstrument[e]&&(i.selected="selected"),s.appendChild(i)}}programChange(e,t){this.channelInstrument[e]=t,this.bankChange(e,this.channelBank[e]),this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") .program > select").value=t)}bankChange(e,t){"object"==typeof this.bankSet[t]?this.channelBank[e]=t:this.percussionPart[e]?this.channelBank[e]=this.isXG?127:128:this.channelBank[e]=0,this.updateProgramSelect(e),this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .bank > select").value=t)}volumeChange(e,t){this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .volume").innerText=t),this.channelVolume[e]=t}expression(e,t){var n,s,i=this.currentNoteOn[e];for(n=0,s=i.length;n<s;++n)i[n].updateExpression(t);this.channelExpression[e]=t}panpotChange(e,t){this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .panpot > meter").value=t),this.channelPanpot[e]=t}pitchBend(e,t,n){var s,i,a=127&t|(127&n)<<7,r=this.currentNoteOn[e],o=a-8192;for(this.element&&(this.element.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .pitchBend > meter").value=o),s=0,i=r.length;s<i;++s)r[s].updatePitchBend(o);this.channelPitchBend[e]=a}pitchBendSensitivity(e,t){this.element&&(document.querySelector(".instrument > .channel:nth-child("+(e+1)+") > .pitchBendSensitivity").innerText=t),this.channelPitchBendSensitivity[e]=t}attackTime(e,t){this.channelAttack[e]=t}decayTime(e,t){this.channelDecay[e]=t}sustinTime(e,t){this.channelSustin[e]=t}releaseTime(e,t){this.channelRelease[e]=t}harmonicContent(e,t){this.channelHarmonicContent[e]=t}cutOffFrequency(e,t){this.channelCutOffFrequency[e]=t}getPitchBendSensitivity(e){return this.channelPitchBendSensitivity[e]}drumInstrumentLevel(e,t){this.percussionVolume[e]=t}allNoteOff(e){var t=this.currentNoteOn[e];for(this.hold(e,0);t.length>0;)this.noteOff(e,t[0].key,0)}allSoundOff(e){for(var t,n=this.currentNoteOn[e];n.length>0;)t=n.shift(),this.noteOff(e,t.key,0),t.release(),t.disconnect();this.hold(e,0)}resetAllControl(e){this.allNoteOff(e),this.expression(e,127),this.pitchBend(e,0,64)}mute(e,t){var n,s,i=this.currentNoteOn[e];if(this.channelMute[e]=t,t)for(n=0,s=i.length;n<s;++n)i[n].disconnect();else for(n=0,s=i.length;n<s;++n)i[n].connect()}setPercussionPart(e,t){this.isXG?this.channelBank[e]=127:this.channelBank[e]=128,this.percussionPart[e]=t}};n.d(t,"WebMidiLink",function(){return o});class o{constructor(e){this.NrpnMsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.NrpnLsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.RpnMsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.RpnLsb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.ready=!1,this.synth,this.loadCallback=function(e){},this.messageHandler=this.onmessage.bind(this),this.xhr,this.rpnMode=!0,this.option=e||{},this.disableDrawSynth=void 0!==e.disableDrawSynth,this.cache=void 0!==e.cache,this.opener,this.placeholder=void 0!==e.placeholder?document.getElementById(e.placeholder):window.document.body,window.addEventListener("DOMContentLoaded",function(){this.ready=!0}.bind(this),!1)}setup(e){var t=window;this.ready?this.load(e):t.addEventListener("DOMContentLoaded",function n(){t.removeEventListener("DOMContentLoaded",n,!1),this.load(e)}.bind(this),!1),t.opener?this.opener=t.opener:t.parent!==t&&(this.opener=t.parent)}load(e){var t=window.opener?window.opener:window.parent,n=this,s=this.placeholder.appendChild(document.createElement("progress")),i=s.parentNode.insertBefore(document.createElement("outpout"),s.nextElementSibling);t.postMessage("link,progress","*"),window.caches.open("wml").then(a=>{fetch(e).then(t=>{if(!t.ok)throw new Error("Network response was not ok.");a.put(e,t),console.info("cached")}).catch(e=>{console.error("There has been a problem with your fetch operation: ",e.message)}),a.match(e).then(e=>{e.arrayBuffer().then(e=>{n.placeholder.removeChild(s),n.placeholder.removeChild(i),n.onload(e),"function"==typeof n.loadCallback&&n.loadCallback(e),t.postMessage("link,ready","*")}).catch(e=>{console.error("Cache API error: ",e.message)})})})}setReverb(e){this.synth.setReverb(e)}cancelLoading(){}onload(e){var t=new Uint8Array(e);this.loadSoundFont(t)}loadSoundFont(e){var t,n=window;this.cancelLoading(),this.synth?(t=this.synth).refreshInstruments(e):(t=this.synth=new r(e),this.disableDrawSynth||this.placeholder.appendChild(t.drawSynth()),t.init(),t.start(),n.addEventListener("message",this.messageHandler,!1)),n.postMessage("link,ready","*")}onmessage(e){var t,n="function"==typeof e.data.split?e.data.split(","):[],s=n!==[]?n.shift():"",i=window.opener?window.opener:window.parent;switch(s){case"midi":this.processMidiMessage(n.map(function(e){return parseInt(e,16)}));break;case"link":if(void 0===i)return;switch(t=n.shift()){case"reqpatch":i.postMessage("link,patch","*");break;case"setpatch":case"ready":i.postMessage("link,ready","*");break;case"progress":i.postMessage("link,progress","*");break;default:console.error("unknown link message:",t)}}}setLoadCallback(e){this.loadCallback=e}processMidiMessage(e){var t=15&e[0],n=this.synth;switch(240&e[0]){case 128:n.noteOff(t,e[1],e[2]);break;case 144:e[2]>0?n.noteOn(t,e[1],e[2]):n.noteOff(t,e[1],0);break;case 176:var s=e[2];switch(e[1]){case 0:n.bankSelectMsb(t,s);break;case 1:break;case 6:if(this.rpnMode)switch(this.RpnMsb[t]){case 0:switch(this.RpnLsb[t]){case 0:n.pitchBendSensitivity(t,s)}}else switch(this.NrpnMsb[t]){case 26:n.drumInstrumentLevel(this.NrpnLsb[t],s)}break;case 38:if(this.rpnMode)switch(this.RpnMsb[t]){case 0:switch(this.RpnLsb[t]){case 0:n.pitchBendSensitivity(t,n.getPitchBendSensitivity(t)+s/100)}}break;case 7:n.volumeChange(t,s);break;case 10:n.panpotChange(t,s);break;case 120:n.allSoundOff(t);break;case 121:n.resetAllControl(t);break;case 32:n.bankSelectLsb(t,s);break;case 71:n.harmonicContent(t,s);break;case 96:case 97:break;case 98:this.rpnMode=!1,this.NrpnLsb[t]=s;break;case 99:this.rpnMode=!1,this.NrpnMsb[t]=s;break;case 100:this.rpnMode=!0,this.RpnLsb[t]=s;break;case 101:this.rpnMode=!0,this.RpnMsb[t]=s;break;case 64:n.hold(t,s);break;case 11:n.expression(t,s);break;case 71:n.cutOffFrequency[t]=s;break;case 72:n.decayTime(t,s);break;case 73:n.releaseTime(t,s);break;case 74:n.attackTime(t,s);break;case 75:n.cutOffFrequency(t,s);break;case 91:n.reverbDepth(t,s)}break;case 192:n.programChange(t,e[1]);break;case 224:n.pitchBend(t,e[1],e[2]);break;case 240:switch(e[1]){case 126:127===e[2]&&9===e[3]&&1===e[4]&&n.init("GM");break;case 127:e[2];switch(e[3]){case 4:switch(e[4]){case 1:n.setMasterVolume(e[5]+(e[6]<<7))}}}switch(e[2]){case 67:switch(8===e[5]&&(0!==e[7]?n.setPercussionPart(e[6],!0):n.setPercussionPart(e[6],!1)),e[7]){case 4:n.setMasterVolume(2*(e[8]<<7));break;case 126:n.init("XG"),console.log("XG Reset")}break;case 65:switch(e[8]){case 4:n.setMasterVolume(e[9]<<7);break;case 127:n.init("GS"),console.log("GS Reset");break;case 21:var i=e[7]-15,a=e[8];0===i?0!==a?n.setPercussionPart(9,!0):n.setPercussionPart(9,!1):i>=10?0!==a?n.setPercussionPart(i-1,!0):n.setPercussionPart(i-1,!1):0!==a?n.setPercussionPart(i,!0):n.setPercussionPart(i,!1)}}break;default:n.setPercussionPart(9,!0)}}}t.default=o}])});